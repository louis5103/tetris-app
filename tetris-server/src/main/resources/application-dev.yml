# ===============================================================================
# Tetris Server Module - WebSocket Multiplayer Game Server
# 멀티플레이 테트리스 게임 서버 설정 (DEV Profile)
# ===============================================================================

spring:
  config:
    activate:
      on-profile: dev
  
  application:
    name: ${SPRING_APPLICATION_NAME:Tetris Multiplayer Server}

  # ===============================================================================
  # Database Configuration (MySQL)
  # ===============================================================================
  datasource:
    url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3307}/${DB_NAME:tetris_dev}?useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
    username: ${DB_USERNAME:team9}
    password: ${DB_PASSWORD:sexy-tetris}
    driver-class-name: com.mysql.cj.jdbc.Driver

  # ===============================================================================
  # JPA / Hibernate Configuration
  # ===============================================================================
  jpa:
    hibernate:
      ddl-auto: ${JPA_DDL_AUTO:update}
    show-sql: ${JPA_SHOW_SQL:true}
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.MySQL8Dialect
        use_sql_comments: true

# ===============================================================================
# Web Server Settings
# ===============================================================================
server:
  port: 8090
  servlet:
    context-path: /

  # WebSocket 최적화
  tomcat:
    threads:
      max: 200
      min-spare: 10
    connection-timeout: 20000
    max-connections: 10000

    # WebSocket 메시지 버퍼 크기 증가 (GameState JSON 전송용)
    # CloseStatus code=1009 (message too big) 오류 해결
    max-http-post-size: 10485760  # 10MB

  # Spring WebSocket 메시지 크기 제한
  websocket:
    max-text-message-buffer-size: 1048576  # 1MB (텍스트 메시지)
    max-binary-message-buffer-size: 1048576  # 1MB (바이너리 메시지)

# ===============================================================================
# P2P Relay Server Configuration
# ===============================================================================
relay:
  udp:
    port: 9090  # UDP 릴레이 포트

# ===============================================================================
# WebSocket Configuration
# ===============================================================================
websocket:
  # STOMP 엔드포인트 설정
  endpoint: /ws-tetris

  # 메시지 브로커 설정
  broker:
    application-prefix: /app
    topic-prefix: /topic
    user-prefix: /user

  # 메시지 크기 제한
  message:
    size-limit: 128KB

  # 허용 오리진
  allowed-origins: ${WEBSOCKET_ALLOWED_ORIGINS:http://localhost:*,http://127.0.0.1:*}

# ===============================================================================
# Game Session Configuration
# ===============================================================================
game:
  session:
    # 최대 동시 게임 세션 수
    max-sessions: 100

    # 세션당 최대 플레이어 수
    max-players-per-session: 4

    # 세션 타임아웃 (밀리초) - 30분
    timeout: 1800000

    # 비활성 세션 정리 주기 (밀리초) - 5분
    cleanup-interval: 300000

    # 게임 상태 브로드캐스트 주기 (밀리초) - 100ms (10fps)
    state-broadcast-interval: 100

  # 게임 규칙
  rules:
    # 레벨업 점수
    level-up-score: 1000

    # 최대 레벨
    max-level: 15

    # 초기 속도 (밀리초)
    initial-speed: 1000

# ===============================================================================
# JWT Configuration
# ===============================================================================
jwt:
  secret: ${JWT_SECRET:your-secret-key-min-256-bits-long-for-hs256-algorithm-please-change-this-in-production}
  expiration: ${JWT_EXPIRATION:86400000}  # 24시간 (밀리초)

# ===============================================================================
# Logging Configuration
# ===============================================================================
logging:
  level:
    root: INFO
    seoultech.se.server: DEBUG
    seoultech.se.core: DEBUG
    org.springframework.web: INFO
    org.springframework.messaging: DEBUG
    org.springframework.web.socket: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE

  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

  file:
    name: ${LOG_FILE:logs/tetris-server.log}
    max-size: 10MB
    max-history: 30

# ===============================================================================
# Development Tools Settings
# ===============================================================================
spring.devtools:
  restart:
    enabled: true
  livereload:
    enabled: true

# ===============================================================================
# Actuator Settings (Monitoring & Health Check)
# ===============================================================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,websocket
      base-path: /actuator

  endpoint:
    health:
      show-details: when-authorized
      probes:
        enabled: true

  metrics:
    enable:
      jvm: true
      process: true
      system: true
    tags:
      application: ${spring.application.name}

# ===============================================================================
# JSON 직렬화 설정
# ===============================================================================
spring.jackson:
  serialization:
    write-dates-as-timestamps: false
    indent-output: true
  deserialization:
    fail-on-unknown-properties: false
  time-zone: Asia/Seoul
  date-format: yyyy-MM-dd'T'HH:mm:ss.SSS

# ===============================================================================
# CORS Configuration (크로스 오리진)
# ===============================================================================
cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:*,http://127.0.0.1:*}
  allowed-methods: GET,POST,PUT,DELETE,OPTIONS
  allowed-headers: "*"
  allow-credentials: true
  max-age: 3600

---
# ===============================================================================
# Development Profile
# ===============================================================================
spring.config.activate.on-profile: dev

server:
  port: 8090

logging:
  level:
    seoultech.se.server: DEBUG
    seoultech.se.server.service.P2PRelayService: INFO
    seoultech.se.server.controller.P2PRelayController: INFO
    org.springframework.messaging: DEBUG
    org.springframework.web.socket: DEBUG

---
# ===============================================================================
# Production Profile
# ===============================================================================
spring.config.activate.on-profile: prod

server:
  port: ${SERVER_PORT:8090}

  # Production 환경 최적화
  tomcat:
    threads:
      max: 500
      min-spare: 50
    max-connections: 20000

logging:
  level:
    root: WARN
    seoultech.se.server: INFO
    seoultech.se.core: INFO
    org.springframework: WARN

game:
  session:
    max-sessions: 500
    max-players-per-session: 4

# Production CORS 설정 (실제 도메인으로 변경 필요)
cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:https://localhost:8080}
  allow-credentials: true
